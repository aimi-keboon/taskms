<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Field Service â€“ Task Details</title>

  <style>
    :root {
      --primary: #2c5aa0;
      --accent: #28a745;
      --text-dark: #1e2a3a;
      --text-light: #6c757d;
      --bg: #f8f9fa;
      --radius: 10px;
    }

    * { box-sizing: border-box; font-family: "Inter", Arial, sans-serif; }

    body {
      background: var(--bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary), #1e3d72);
      color: white;
      padding: 18px 20px;
      text-align: center;
      font-weight: 600;
      font-size: 1.2rem;
    }

    .container {
      padding: 20px;
      flex: 1;
    }

    .task-info {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 18px;
      margin-bottom: 20px;
    }

    .task-info h3 {
      margin: 0 0 10px;
      color: var(--primary);
      font-size: 1.2rem;
    }

    .task-detail {
      margin-bottom: 8px;
      font-size: 0.95rem;
      color: var(--text-dark);
    }

    .task-detail span {
      color: var(--text-light);
    }

    .subtasks {
      background: white;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 18px;
      margin-bottom: 20px;
    }

    .subtasks h3 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-dark);
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.25s;
    }

    .btn-start {
      background: var(--accent);
      color: white;
    }

    .btn-start:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(40,167,69,0.25);
    }

    .btn-start:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn-complete {
      background: var(--primary);
      color: white;
    }

    .btn-complete:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .gps-box {
      background: #e9f7ef;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 10px;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert {
      padding: 10px;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      margin-bottom: 15px;
      text-align: center;
    }

    footer {
      text-align: center;
      padding: 12px;
      color: var(--text-light);
      font-size: 0.8rem;
    }
  </style>
</head>

<body>
  <header>Task Details</header>

  <div class="container">
    <div id="alertBox" class="alert" style="display:none;"></div>

    <div class="task-info" id="taskInfo">
      <h3>Loading...</h3>
    </div>

    <div class="subtasks" id="subtasksSection">
      <h3>Checklist</h3>
      <div id="checklist"></div>
    </div>

    <div class="actions">
      <button id="startBtn" class="btn-start">Start Task</button>
      <button id="completeBtn" class="btn-complete" disabled>Complete Task</button>
    </div>

    <div id="gpsBox" class="gps-box" style="display:none;"></div>
  </div>

  <footer>Â© 2025 Synergy Alliance â€“ Field Service Monitoring System</footer>

<script>
  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycbxVyHDJPIXxxVsAgsbpcv01HKNVh4HkszcTGTLOMbIOUwu8RtdRBWobiiuAQb3tVt6H/exec";

  const alertBox = document.getElementById("alertBox");
  const taskInfo = document.getElementById("taskInfo");
  const checklistContainer = document.getElementById("checklist");
  const startBtn = document.getElementById("startBtn");
  const completeBtn = document.getElementById("completeBtn");
  const gpsBox = document.getElementById("gpsBox");

  const subtasks = [
    "Arrived at client site",
    "Setup and installation",
    "System configuration",
    "Client walkthrough / training",
    "Final verification and sign-off"
  ];

  let currentTask = {};

  function showAlert(msg, type = "error", autoHide = false) {
    alertBox.innerText = msg;
    alertBox.style.display = "block";
    alertBox.style.background = type === "success" ? "#d4edda" : "#f8d7da";
    alertBox.style.color = type === "success" ? "#155724" : "#721c24";

    if (autoHide) {
      setTimeout(() => (alertBox.style.display = "none"), 1500);
    }
  }

  function renderTask() {
    const task = JSON.parse(localStorage.getItem("selectedTask") || "{}");
    currentTask = task;

    const isDone = task.status === "Done";
    const isStarted = task.status === "In Progress";

    taskInfo.innerHTML = `
      <h3>${task.client}</h3>
      <div class="task-detail"><strong>Location:</strong> <span>${task.location}</span></div>
      <div class="task-detail"><strong>Scheduled:</strong> <span>${task.date} ${task.time}</span></div>
      <div class="task-detail"><strong>Status:</strong> <span>${task.status}</span></div>
    `;

    checklistContainer.innerHTML = "";
    subtasks.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "checkbox-item";
      div.innerHTML = `
          <input type="checkbox" id="chk${i}" ${isDone ? "disabled checked" : ""} ${isStarted ? "" : "disabled"} />
          <label for="chk${i}">${item}</label>
      `;
      checklistContainer.appendChild(div);
    });

    startBtn.disabled = isStarted || isDone;
    completeBtn.disabled = true;

    if (isDone) {
      completeBtn.disabled = true;
    }
  }

  function updateCompletionState() {
    if (currentTask.status !== "In Progress") {
      completeBtn.disabled = true;
      return;
    }

    const allChecked = [...document.querySelectorAll("#checklist input[type='checkbox']")]
      .every(chk => chk.checked);

    completeBtn.disabled = !allChecked;
  }

  function captureGPS() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) reject("GPS not supported");

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          gpsBox.style.display = "block";
          gpsBox.innerText = `ðŸ“ Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
          resolve({ lat: latitude, lon: longitude });
        },
        () => reject("Unable to get GPS")
      );
    });
  }

  async function callAPI(action, params = {}) {
    const query = new URLSearchParams({ action, ...params }).toString();
    const res = await fetch(`${SCRIPT_URL}?${query}`);
    const text = await res.text();
    try { return JSON.parse(text); } catch { return { success: false, message: text }; }
  }

  async function startTask() {
    startBtn.disabled = true;
    showAlert("Starting task...", "success");

    try {
      const gps = await captureGPS();

      const res = await callAPI("updateTaskStart", {
        taskID: currentTask.id,
        lat: gps.lat,
        lon: gps.lon
      });

      if (res.success) {
        showAlert("Task started successfully!", "success", true);

        currentTask.status = "In Progress";
        startBtn.disabled = true;

        document.querySelectorAll("#checklist input").forEach(chk => chk.disabled = false);

        updateCompletionState();
      } else {
        showAlert(res.message || "Failed to start task.");
        startBtn.disabled = false;
      }
    } catch (err) {
      showAlert("Error starting task: " + err);
      startBtn.disabled = false;
    }
  }

  async function completeTask() {
    completeBtn.disabled = true;

    showAlert("Completing task...", "success");

    try {
      const gps = await captureGPS();

      const res = await callAPI("updateTaskComplete", {
        taskID: currentTask.id,
        lat: gps.lat,
        lon: gps.lon
      });

      if (res.success) {
        showAlert("Task completed!", "success");

        setTimeout(() => {
          localStorage.removeItem("selectedTask");
          window.location.href = "tasklist.html";
        }, 1000);
      } else {
        showAlert(res.message || "Failed to complete task.");
      }
    } catch (err) {
      showAlert("Error completing task: " + err);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    renderTask();

    document.querySelectorAll("#checklist input")
      .forEach(chk => chk.addEventListener("change", updateCompletionState));

    startBtn.addEventListener("click", startTask);
    completeBtn.addEventListener("click", completeTask);
  });
</script>

</body>
</html>
