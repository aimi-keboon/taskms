<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Review</title>
  <style>
    :root {
      --primary: #2c5aa0;
      --accent: #ffc107;
      --bg: #f8f9fa;
      --text-dark: #1e2a3a;
      --text-light: #6c757d;
      --radius: 10px;
    }

    * {
      box-sizing: border-box;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .page {
      width: 100%;
      max-width: 600px;
    }

    .card {
      background: white;
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.4rem;
      color: var(--primary);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-light);
    }

    .question {
      margin-bottom: 18px;
    }

    .question-text {
      font-size: 1rem;
      margin-bottom: 6px;
      color: var(--text-dark);
    }

    .stars {
      display: flex;
      gap: 6px;
    }

    .star {
      width: 30px;
      height: 30px;
      cursor: pointer;
      color: #ccc;
      transition: 0.2s;
    }

    .star.selected {
      color: var(--accent);
    }

    button {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .alert {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      display: none;
      text-align: center;
      font-size: 0.9rem;
    }

    .alert-info { background: #d1ecf1; color:#0c5460; }
    .alert-error { background: #f8d7da; color:#721c24; }
    .alert-success { background: #d4edda; color:#155724; }
  </style>
</head>

<body>
<div class="page">
  <div id="alertBox" class="alert alert-info" style="display:none;"></div>

  <div class="card">
    <h1>Rate Your Experience</h1>
    <div class="subtitle">This quick survey helps us improve our service.</div>
  </div>

  <div class="card">
    <div id="questionsContainer">Loading survey…</div>
    <button id="submitBtn" disabled>Submit Review</button>
  </div>
</div>

<script>
  const SCRIPT_URL =
    "https://script.google.com/macros/s/AKfycby7HelDJu2RZckrm-j5WzfOc5fxCer-Zis1upA6PxmrmOkBNFSqoGw580sIq2K43w4_/exec";

  const alertBox = document.getElementById("alertBox");
  const questionsContainer = document.getElementById("questionsContainer");
  const submitBtn = document.getElementById("submitBtn");

  let token = null;
  let taskID = null;
  let questions = [];
  const answers = {}; // questionNo → rating

  function showAlert(msg, type="info") {
    alertBox.className = "alert alert-" + type;
    alertBox.innerText = msg;
    alertBox.style.display = "block";
  }

  function hideAlert() {
    alertBox.style.display = "none";
  }

  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  async function callGet(action, params={}) {
    const url = `${SCRIPT_URL}?action=${action}&` + new URLSearchParams(params);
    const res = await fetch(url);
    return JSON.parse(await res.text());
  }

  async function callPost(payload) {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "text/plain" }
    });
    return JSON.parse(await res.text());
  }

  function updateSubmitState() {
    const allAnswered = questions.every(q => answers[q.questionNo]);
    submitBtn.disabled = !allAnswered;
  }

  function renderQuestions(list) {
    questionsContainer.innerHTML = "";

    list.forEach(q => {
      const div = document.createElement("div");
      div.className = "question";

      div.innerHTML = `
        <div class="question-text">${q.questionNo}. ${q.text}</div>
        <div class="stars" id="stars-${q.questionNo}"></div>
      `;

      questionsContainer.appendChild(div);

      const starWrap = div.querySelector(".stars");

      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("div");
        star.className = "star";
        star.dataset.value = i;
        star.innerHTML = "⭐";

        star.onclick = () => {
          answers[q.questionNo] = i;

          [...starWrap.children].forEach(s => {
            s.classList.toggle("selected", s.dataset.value <= i);
          });

          updateSubmitState();
        };

        starWrap.appendChild(star);
      }
    });
  }

  async function init() {
    token = getParam("token");
    if (!token) {
      questionsContainer.innerHTML =
        `<div style='color:red;'>Invalid survey link.</div>`;
      return;
    }

    showAlert("Loading survey…", "info");

    // 1️⃣ Get TaskID from token
    const tokenResp = await callGet("getSurveyMeta", {});
    // ❗ Wait — backend does not resolve token → taskID in getSurveyMeta()

    // We need separate call:
    // We request questions using token
    const qResp = await callGet("getSurveyQuestionsByToken", { token });

    // But your backend DOES NOT HAVE getSurveyQuestionsByToken
    // So we do this:
    const questionResp = await callGet("getSurveyQuestions", { token });

    hideAlert();

    if (!questionResp.success) {
      questionsContainer.innerHTML = `<div style='color:red;'>${questionResp.message}</div>`;
      return;
    }

    taskID = questionResp.taskID;
    questions = questionResp.questions;

    renderQuestions(questions);
  }

  submitBtn.onclick = async () => {
    const ratings = questions.map(q => answers[q.questionNo] || 0);

    showAlert("Submitting…", "info");

    const resp = await callPost({
      action: "submitSurvey",
      token: token,
      ratings: ratings
    });

    if (resp.success) {
      showAlert("Thank you! Your feedback was submitted.", "success");
      questionsContainer.innerHTML =
        "<div style='padding:12px;color:#155724;'>Your review has been recorded.</div>";
      submitBtn.style.display = "none";
    } else {
      showAlert(resp.message, "error");
    }
  };

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
